name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan

jobs:
  sast:
    name: SAST - Static Application Security Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Bandit
      run: pip install bandit
      continue-on-error: true

    - name: Run Bandit scan on Python code
      working-directory: ./vote
      run: |
        bandit -r . -ll || true
      continue-on-error: true

    - name: Run ESLint on Node.js code
      working-directory: ./result
      run: |
        npm ci || true
        npx eslint . || true
      continue-on-error: true

  dast:
    name: DAST - Dynamic Application Security Testing
    runs-on: ubuntu-latest
    needs: sast
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start application with Docker Compose
      run: |
        docker compose up -d
        sleep 30

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:8080'
        cmd_options: '-a'
      continue-on-error: true

    - name: Stop Docker Compose
      if: always()
      run: docker compose down

  container-scan:
    name: Container Image Scanning
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [vote, result, worker, seed-data]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t ${{ matrix.service }}:test ./${{ matrix.service }}

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.service }}:test
        format: 'table'
        exit-code: '0'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true

    # Docker Bench Security - Optional, can be run manually
    # - name: Run Docker Bench Security
    #   run: |
    #     docker run --rm --net host --pid host --userns host --cap-add audit_control \
    #       -v /var/lib:/var/lib -v /var/run/docker.sock:/var/run/docker.sock \
    #       -v /etc:/etc --label docker_bench_security \
    #       docker/docker-bench-security || true

